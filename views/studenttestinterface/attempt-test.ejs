<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NTA CBT Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f2f2f2}

/* HEADER */
.header{
  height:60px;background:#0b3c6d;color:#fff;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px
}
.timer{
  background:#fff;color:#0b3c6d;
  padding:6px 14px;border-radius:4px;font-weight:bold
}

/* STATUS */
.status-bar{
  display:flex;flex-wrap:wrap;gap:12px;
  background:#fff;padding:8px 12px;
  border-bottom:1px solid #ccc;
  font-size:13px;font-weight:bold
}

/* LAYOUT */
.wrapper{display:flex;height:calc(100vh - 108px)}
.left{flex:1;background:#fff;padding:12px;overflow:auto}
.right{
  width:360px;background:#f9f9f9;border-left:2px solid #ccc;
  padding:10px;overflow:auto
}

/* QUESTION */
.question-title{font-weight:bold;margin-bottom:10px}
.question-img{max-width:100%;border:1px solid #ccc;padding:10px}

/* OPTIONS */
.option{
  border:1px solid #999;padding:12px;margin:8px 0;
  cursor:pointer;border-radius:4px
}
.option.selected{
  background:#e6f0ff;border:2px solid #2b6cb0
}

/* BUTTONS */
.button-bar{
  margin-top:15px;
  display:flex;
  flex-wrap:wrap;
  gap:10px
}
.btn{
  padding:10px 14px;
  border:none;font-weight:bold;
  cursor:pointer;border-radius:4px
}
.save{background:#4caf50;color:#fff}
.clear{background:#fff;border:1px solid #999}
.save-review{background:#f0ad4e;color:#fff}
.review-next{background:#337ab7;color:#fff}

/* SECTION */
.section-tabs{display:flex;gap:5px;margin-bottom:10px}
.section-tabs button{
  flex:1;padding:8px;font-weight:bold;border:none;
  cursor:pointer;background:#ddd;border-radius:4px
}
.section-tabs button.active{background:#0b3c6d;color:#fff}

/* LEGEND */
.legend div{
  display:flex;align-items:center;gap:10px;
  margin-bottom:6px;font-size:13px;font-weight:bold
}
.box{width:22px;height:22px;border-radius:4px}
.nv{background:#ddd}
.na{background:#e74c3c}
.a{background:#2ecc71}
.r{background:#8e44ad}
.ra{background:#8e44ad;position:relative}
.ra::after{
  content:"";width:7px;height:7px;
  background:#2ecc71;border-radius:50%;
  position:absolute;bottom:2px;right:2px
}

/* PALETTE */
.palette{
  margin-top:10px;
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:8px
}
.palette button{
  padding:8px;border:none;font-weight:bold;
  cursor:pointer;color:#fff;border-radius:4px
}
.palette .nv{color:#000}

/* SUBMIT */
.submit{
  width:100%;margin-top:12px;
  background:#4caf50;color:#fff;
  border:none;padding:12px;
  font-size:16px;border-radius:4px
}

/* ---------------- MOBILE ---------------- */
@media(max-width:768px){

  .wrapper{
    flex-direction:column;
    height:auto
  }

  .right{
    width:100%;
    border-left:none;
    border-top:2px solid #ccc
  }

  .palette{
    grid-template-columns:repeat(10,1fr);
    overflow-x:auto
  }

  .palette button{
    min-width:38px
  }

  .button-bar{
    flex-direction:column
  }

  .btn{
    width:100%
  }

  .option{
    font-size:15px
  }

  .status-bar{
    font-size:12px
  }
}

/* VERY SMALL */
@media(max-width:480px){
  .timer{font-size:14px}
  .question-title{font-size:14px}
}
</style>
</head>

<body>

<div class="header">
  <div><%= test.title %></div>
  <div class="timer" id="timer">00:00:00</div>
</div>

<div class="status-bar">
  <div>Attempted: <span id="attemptedCnt">0</span></div>
  <div>Not Answered: <span id="skippedCnt">0</span></div>
  <div>Marked: <span id="reviewCnt">0</span></div>
  <div>Not Visited: <span id="notVisitedCnt"><%= test.questions.length %></span></div>
</div>

<div class="wrapper">

<div class="left">
<form id="testForm" method="POST" action="/student/test/<%= test._id %>">

<%
const total = test.questions.length;
const oneThird = Math.ceil(total/3);
const twoThird = Math.ceil(2*total/3);
%>

<% test.questions.forEach((q,i)=>{ 
  const section = i < oneThird ? 'Physics' : i < twoThird ? 'Chemistry' : 'Mathematics';
%>

<div class="question"
     id="q-<%= i %>"
     data-qid="<%= q._id %>"
     data-section="<%= section %>"
     style="display:none">

  <div class="question-title">
    Question <%= i+1 %>
  </div>

  <img class="question-img" src="<%= q.questionText %>">

  <% q.options.forEach((op,j)=>{ %>
    <div class="option" onclick="selectOpt(<%= i %>,<%= j %>)"><%= op %></div>
  <% }) %>

  <input type="hidden" id="ans-<%= i %>">

  <div class="button-bar">
    <button type="button" class="btn save" onclick="saveNext(<%= i %>)">Save & Next</button>
    <button type="button" class="btn clear" onclick="clearAns(<%= i %>)">Clear</button>
    <button type="button" class="btn save-review" onclick="saveReview(<%= i %>)">Save & Mark</button>
    <button type="button" class="btn review-next" onclick="reviewNext(<%= i %>)">Mark & Next</button>
  </div>

</div>
<% }) %>

</form>
</div>

<div class="right">

<div class="section-tabs">
  <button onclick="switchSection('Physics',this)">Physics</button>
  <button onclick="switchSection('Chemistry',this)">Chemistry</button>
  <button onclick="switchSection('Mathematics',this)">Maths</button>
</div>

<div class="legend">
  <div><div class="box nv"></div> Not Visited</div>
  <div><div class="box na"></div> Not Answered</div>
  <div><div class="box a"></div> Answered</div>
  <div><div class="box r"></div> Marked</div>
  <div><div class="box ra"></div> Ans + Marked</div>
</div>

<div class="palette">
<% test.questions.forEach((q,i)=>{ 
  const sec = i < oneThird ? 'Physics' : i < twoThird ? 'Chemistry' : 'Mathematics';
%>
<button id="p-<%= i %>" class="nv" data-section="<%= sec %>"
        onclick="showQ(<%= i %>)"><%= i+1 %></button>
<% }) %>
</div>

<button class="submit" onclick="submitTest()">SUBMIT</button>
</div>
</div>

<script>
const totalQ = <%= test.questions.length %>;
let cur=0;
let time=<%= test.time %>*60;
let state=Array(totalQ).fill("nv");
let solution={};

/* â± Accurate Time Tracking */
let questionTime={};
let currentQIndex=null;
let currentQStart=null;

/* Timer */
setInterval(()=>{
  if(time<=0) submitTest();
  const h=String(Math.floor(time/3600)).padStart(2,'0');
  const m=String(Math.floor((time%3600)/60)).padStart(2,'0');
  const s=String(time%60).padStart(2,'0');
  timer.innerText=`${h}:${m}:${s}`;
  time--;
},1000);

/* Counts */
function updateCounts(){
  attemptedCnt.innerText=state.filter(x=>x==="a").length;
  skippedCnt.innerText=state.filter(x=>x==="na").length;
  reviewCnt.innerText=state.filter(x=>x==="r"||x==="ra").length;
  notVisitedCnt.innerText=state.filter(x=>x==="nv").length;
}

/* Show Question + Time */
function showQ(i){
  if(currentQIndex!==null){
    const spent=Math.floor((Date.now()-currentQStart)/1000);
    questionTime[currentQIndex]=(questionTime[currentQIndex]||0)+spent;
  }
  document.querySelectorAll(".question").forEach(q=>q.style.display="none");
  document.getElementById("q-"+i).style.display="block";
  currentQIndex=i;
  currentQStart=Date.now();
  if(state[i]==="nv") state[i]="na";
  updateUI();
}

function selectOpt(i,j){
  document.querySelectorAll(`#q-${i} .option`).forEach(o=>o.classList.remove("selected"));
  document.querySelectorAll(`#q-${i} .option`)[j].classList.add("selected");
  document.getElementById("ans-"+i).value=j;
}

function saveNext(i){
  const v=ans(i);
  state[i]=v!==""?"a":"na";
  solution[i]=v!==""?v:-1;
  nextQ();
}

function saveReview(i){
  const v=ans(i);
  state[i]=v!==""?"ra":"r";
  solution[i]=v!==""?v:-1;
  nextQ();
}

function reviewNext(i){
  state[i]="r";
  solution[i]=-1;
  nextQ();
}

function clearAns(i){
  document.getElementById("ans-"+i).value="";
  state[i]="na";
  updateUI();
}

function nextQ(){ if(cur+1<totalQ) showQ(++cur); }
function ans(i){ return document.getElementById("ans-"+i).value; }

function switchSection(sec,btn){
  document.querySelectorAll(".section-tabs button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  document.querySelectorAll(".palette button").forEach(b=>{
    b.style.display=b.dataset.section===sec?"block":"none";
  });
  const q=[...document.querySelectorAll(".question")]
          .find(x=>x.dataset.section===sec);
  if(q) showQ(Number(q.id.split("-")[1]));
}

function updateUI(){
  state.forEach((s,i)=>document.getElementById("p-"+i).className=s);
  updateCounts();
}

/* Submit */
function submitTest(){
  if(currentQIndex!==null){
    const spent=Math.floor((Date.now()-currentQStart)/1000);
    questionTime[currentQIndex]=(questionTime[currentQIndex]||0)+spent;
  }
  const form=document.getElementById("testForm");
  Object.entries(solution).forEach(([i,v])=>{
    const qDiv=document.getElementById("q-"+i);
    const qid=qDiv.dataset.qid;

    const a=document.createElement("input");
    a.type="hidden";a.name=`solution[${qid}]`;a.value=v;
    form.appendChild(a);

    const t=document.createElement("input");
    t.type="hidden";t.name=`timeSpent[${qid}]`;t.value=questionTime[i]||0;
    form.appendChild(t);
  });
  form.submit();
}

/* Init Physics */
(function(){
  const btn=document.querySelector(".section-tabs button");
  switchSection("Physics",btn);
})();
</script>

</body>
</html>
