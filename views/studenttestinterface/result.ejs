<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Detailed Analysis</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:Arial;
  background:#f4f6f8;
  padding:10px;
}

h2,h3{margin-bottom:8px}

/* CARD */
.card{
  background:#fff;
  padding:12px;
  margin-bottom:16px;
  border-radius:6px;
  box-shadow:0 2px 8px rgba(0,0,0,.1)
}

/* SUMMARY */
.summary{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.summary div{
  background:#eef2f7;
  padding:10px;
  border-radius:5px;
  font-weight:bold;
  flex:1;
  min-width:140px;
  text-align:center;
}

/* STATUS COLORS */
.correct{color:#2ecc71;font-weight:bold}
.incorrect{color:#e74c3c;font-weight:bold}
.skipped{color:#999;font-weight:bold}

/* WATCH ICON */
.time-row{
  margin-top:6px;
  font-size:14px;
  color:#555;
  display:flex;
  align-items:center;
  gap:6px;
}
.time-row i{
  font-style:normal;
}

/* TABLE (DESKTOP) */
.table-wrapper{
  width:100%;
  overflow-x:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  min-width:700px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #ddd;
  text-align:center;
  font-size:14px;
}
th{
  background:#0b3c6d;
  color:#fff;
}

/* QUESTION IMAGE */
img{
  max-width:100%;
  height:auto;
  border:1px solid #ccc;
  padding:4px;
  margin-top:6px;
}

/* MOBILE QUESTION CARD */
.q-card{
  display:none;
  background:#fff;
  padding:12px;
  margin-bottom:12px;
  border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.1)
}

/* CHART FIX */
canvas{
  max-width:100% !important;
  height:auto !important;
}

/* MOBILE */
@media(max-width:768px){
  table{display:none}
  .q-card{display:block}
}
</style>
</head>

<body>

<h2>üìä Detailed Test Analysis</h2>

<!-- SUMMARY -->
<div class="card summary">
  <div>Total Time<br><span id="totalTime">0</span>s</div>
  <div>Avg / Question<br><span id="avgTime">0</span>s</div>
  <div>Efficiency Score<br><span id="efficiency">0</span>/100</div>
</div>

<!-- TIME PER QUESTION -->
<div class="card">
  <h3>‚è± Time per Question</h3>
  <canvas id="timeChart"></canvas>
</div>

<!-- SUBJECT GRAPH -->
<div class="card">
  <h3>üìò Subject-wise Time & Accuracy</h3>
  <canvas id="subjectChart"></canvas>
</div>

<!-- QUESTION ANALYSIS -->
<div class="card">
<h3>üìã Question-wise Analysis</h3>

<!-- DESKTOP TABLE -->
<div class="table-wrapper">
<table>
<thead>
<tr>
  <th>Q No</th>
  <th>Question</th>
  <th>Status</th>
  <th>Selected</th>
  <th>Correct</th>
  <th>Time (s)</th>
</tr>
</thead>
<tbody>

<% studentTest.answers.forEach((ans,i)=>{ 
   const q = test.questions.find(x=>x._id.toString()===ans.questionId.toString());
%>

<tr>
<td><%= i+1 %></td>

<td>
  <% if(q.questionText && q.questionText.startsWith("http")){ %>
    <img src="<%= q.questionText %>">
  <% } else { %>
    <%= q.questionText %>
  <% } %>
</td>

<td class="<%= ans.isCorrect==='yes'?'correct':ans.isCorrect==='no'?'incorrect':'skipped' %>">
  <%= ans.isCorrect==='yes'?'Correct':ans.isCorrect==='no'?'Incorrect':'Skipped' %>
</td>

<td><%= ans.selectedOption===-1?'‚Äî':ans.selectedOption %></td>
<td><%= q.correctAnswer %></td>
<td><%= ans.timeSpent %></td>
</tr>

<% }) %>

</tbody>
</table>
</div>

<!-- MOBILE CARDS -->
<% studentTest.answers.forEach((ans,i)=>{ 
   const q = test.questions.find(x=>x._id.toString()===ans.questionId.toString());
%>

<div class="q-card">
  <strong>Question <%= i+1 %></strong>

  <% if(q.questionText && q.questionText.startsWith("http")){ %>
    <img src="<%= q.questionText %>">
  <% } else { %>
    <p><%= q.questionText %></p>
  <% } %>

  <p class="<%= ans.isCorrect==='yes'?'correct':ans.isCorrect==='no'?'incorrect':'skipped' %>">
    <%= ans.isCorrect==='yes'?'‚úî Correct':ans.isCorrect==='no'?'‚úñ Incorrect':'‚óã Skipped' %>
  </p>

  <p>Selected: <strong><%= ans.selectedOption===-1?'‚Äî':ans.selectedOption %></strong></p>
  <p>Correct: <strong><%= q.correctAnswer %></strong></p>

  <div class="time-row">
    ‚è± <span>Time Taken: <strong><%= ans.timeSpent %> sec</strong></span>
  </div>
</div>

<% }) %>

</div>

<script>
const answers = <%- JSON.stringify(studentTest.answers) %>;

let totalTime=0, correctCnt=0;
const labels=[], times=[], colors=[];
const subj={Physics:{t:0,c:0,a:0},Chemistry:{t:0,c:0,a:0},Mathematics:{t:0,c:0,a:0}};

answers.forEach((a,i)=>{
  totalTime+=a.timeSpent;
  labels.push("Q"+(i+1));
  times.push(a.timeSpent);

  const subject=i<Math.ceil(answers.length/3)?"Physics":i<Math.ceil(2*answers.length/3)?"Chemistry":"Mathematics";
  subj[subject].t+=a.timeSpent;

  if(a.isCorrect==="yes"){
    correctCnt++; subj[subject].c++; subj[subject].a++;
    colors.push("#2ecc71");
  }else if(a.isCorrect==="no"){
    subj[subject].a++;
    colors.push("#e74c3c");
  }else{
    colors.push("#bdc3c7");
  }
});

document.getElementById("totalTime").innerText=totalTime;
document.getElementById("avgTime").innerText=(totalTime/answers.length).toFixed(1);

/* Efficiency Score */
const accuracy=correctCnt/answers.length;
const avgTime=totalTime/answers.length;
let efficiency=(accuracy*70)+Math.max(0,(30-avgTime));
efficiency=Math.min(100,Math.round(efficiency));
document.getElementById("efficiency").innerText=efficiency;

/* Charts */
new Chart(timeChart,{
  type:"bar",
  data:{labels,datasets:[{data:times,backgroundColor:colors}]},
  options:{responsive:true,scales:{y:{beginAtZero:true}}}
});

new Chart(subjectChart,{
  type:"bar",
  data:{
    labels:["Physics","Chemistry","Mathematics"],
    datasets:[
      {label:"Time (s)",data:[subj.Physics.t,subj.Chemistry.t,subj.Mathematics.t],backgroundColor:"#3498db"},
      {label:"Accuracy (%)",data:[
        subj.Physics.c/(subj.Physics.a||1)*100,
        subj.Chemistry.c/(subj.Chemistry.a||1)*100,
        subj.Mathematics.c/(subj.Mathematics.a||1)*100
      ],backgroundColor:"#2ecc71"}
    ]
  },
  options:{responsive:true,scales:{y:{beginAtZero:true,max:100}}}
});
</script>

</body>
</html>
